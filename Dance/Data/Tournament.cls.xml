<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="Dance.Data.Tournament">
<Description>
Tournaments</Description>
<Super>%Persistent</Super>
<TimeCreated>63274,63417.76954</TimeCreated>

<Property name="AccessCode">
<Type>%String</Type>
<Required>1</Required>
</Property>

<Property name="IdInternal">
<Type>%String</Type>
<Required>1</Required>
</Property>

<Property name="IdExternal">
<Type>%String</Type>
<Required>1</Required>
</Property>

<Property name="Hash">
<Type>%String</Type>
<Parameter name="MAXLEN" value="100"/>
</Property>

<Property name="Name">
<Type>Dance.Data.Localization.LText</Type>
<Required>1</Required>
</Property>

<Property name="FullName">
<Type>Dance.Data.Localization.LText</Type>
<Required>1</Required>
</Property>

<Property name="Country">
<Type>Country</Type>
<Required>1</Required>
</Property>

<Property name="City">
<Type>Dance.Data.Localization.LText</Type>
<Required>1</Required>
</Property>

<Property name="StartDate">
<Type>%Date</Type>
<Parameter name="FORMAT" value="3"/>
</Property>

<Property name="EndDate">
<Type>%Date</Type>
<Parameter name="FORMAT" value="3"/>
</Property>

<Property name="OrganizerInfo">
<Type>Dance.Data.Localization.LText</Type>
<Required>1</Required>
</Property>

<Property name="OrganizerSite">
<Type>%String</Type>
<Parameter name="MAXLEN" value="500"/>
</Property>

<Property name="TRank">
<Type>Dance.Data.TournamentRank</Type>
<Required>1</Required>
</Property>

<Property name="TStatus">
<Type>Dance.Data.TournamentStatus</Type>
<Required>1</Required>
</Property>

<Property name="CompetitionsCount">
<Type>%Integer</Type>
<Calculated>1</Calculated>
<SqlComputeCode>set {CompetitionsCount} = ##class({%%CLASSNAME}).GetCompetitionsCount({%%ID})</SqlComputeCode>
<SqlComputed>1</SqlComputed>
</Property>

<Property name="ParticipantsCount">
<Type>%Integer</Type>
<Calculated>1</Calculated>
<SqlComputeCode>set {ParticipantsCount} = ##class({%%CLASSNAME}).GetParticipantsCount({%%ID})</SqlComputeCode>
<SqlComputed>1</SqlComputed>
</Property>

<Property name="ParticipantsUniqueCount">
<Type>%Integer</Type>
<Calculated>1</Calculated>
<SqlComputeCode>set {ParticipantsUniqueCount} = ##class({%%CLASSNAME}).GetParticipantsUniqueCount({%%ID})</SqlComputeCode>
<SqlComputed>1</SqlComputed>
</Property>

<Property name="Competitions">
<Type>Dance.Data.Competition</Type>
<Cardinality>many</Cardinality>
<Inverse>Tournament</Inverse>
<Relationship>1</Relationship>
</Property>

<Property name="IsActive">
<Type>%Boolean</Type>
<InitialExpression>1</InitialExpression>
<Required>1</Required>
</Property>

<Property name="TabUDSRAllowed">
<Type>%Boolean</Type>
<Required>1</Required>
</Property>

<Property name="TabWDSFAllowed">
<Type>%Boolean</Type>
<Required>1</Required>
</Property>

<Property name="TabOtherAllowed">
<Type>%Boolean</Type>
<Required>1</Required>
</Property>

<Index name="IdInternalIdx">
<Properties>IdInternal</Properties>
<Unique>1</Unique>
</Index>

<Index name="IdExternalIdx">
<Properties>IdExternal</Properties>
<Unique>1</Unique>
</Index>

<Method name="ConvertToProxyObject">
<FormalSpec>params:%ZEN.proxyObject</FormalSpec>
<ReturnType>%ZEN.proxyObject</ReturnType>
<Implementation><![CDATA[
	set proxy = ##class(%ZEN.proxyObject).%New()
	
	set proxy.id = ..%Id()
	set proxy.idInternal = ..IdInternal
	set proxy.idExternal = ..IdExternal
	set proxy.startDate = $ZDATE(..StartDate, 3)
	set proxy.endDate = $ZDATE(..EndDate, 3)
		
	if (##class(Dance.Data.Tournament).CheckUpdatePrivilege() = $$$OK){
		set proxy.hash = ..Hash
	}
	
	if (params.loadName){	
		set proxy.name = ..Name.Value
	}
	
	if (params.loadFullName){
		set proxy.fullName = ..FullName.Value
	}
	
	if (params.loadStatus){
		set proxy.status = ..TStatus.ConvertToProxyObject()
	}
	
	if (params.loadRank){
		set proxy.rank = ..TRank.ConvertToProxyObject()
	}
	
	if (params.loadCompetitionsCount){
		set proxy.competitionsCount = ..CompetitionsCount
	}
	
	if (params.loadParticipantsCount){
		set proxy.participantsCount = ..ParticipantsCount
	}

	if (params.loadParticipantsUniqueCount){
		set proxy.participantsUniqueCount = ..ParticipantsUniqueCount
	}
	
	set proxy.location = ##class(%ZEN.proxyObject).%New()
	if (params.loadLocation){		
		set proxy.location.country = ..Country.ConvertToProxyObject()
		set proxy.location.cityName = ..City.Value
	}
	
	set proxy.organizer = ##class(%ZEN.proxyObject).%New()
	if (params.loadOrganizer){	
		set proxy.organizer.info = ..OrganizerInfo.Value
		set proxy.organizer.site = ..OrganizerSite
	}
	
	set proxy.tabUDSRAllowed = ..TabUDSRAllowed
	set proxy.tabWDSFAllowed = ..TabWDSFAllowed
	set proxy.tabOtherAllowed = ..TabOtherAllowed
	
	quit proxy
]]></Implementation>
</Method>

<Method name="Save">
<Description>
Create or Update object</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[data:%RegisteredObject,&st]]></FormalSpec>
<ReturnType>Tournament</ReturnType>
<Implementation><![CDATA[
	do ##class(Dance.Utils.Journal).Create("Log", "Data.Tournament.Save",
	"ID="_data.id_";"_
	"IdInternal="_data.idInternal_";"_
	"IdExternal="_data.idExternal_";"_
	"Hash="_data.hash_";"_
	"Name="_data.name_";"_
	"TStatusId="_data.status.id_";"_
	"TRankId="_data.rank.id_";"_
	"CountryId="_data.location.country.id_";"_
	"City="_data.location.cityName_";"_
	"StartDate="_data.startDate_";"_
	"endDate="_data.startDate)
	
	set trn = ""
	if (data.id = ""){
		set trn = ..%New()
		set trn.AccessCode = $SYSTEM.Util.CreateGUID()
      	set trn.Name = ##class(Dance.Data.Localization.LText).Create(data.name)
      	set trn.FullName = ##class(Dance.Data.Localization.LText).Create(data.fullName)
      	set trn.City = ##class(Dance.Data.Localization.LText).Create(data.location.cityName)
      	set trn.OrganizerInfo = ##class(Dance.Data.Localization.LText).Create(data.organizer.info)
    }
    else{
	    set trn = ..%OpenId(data.id)
      	set trn.Name.Value = data.name
      	set trn.FullName.Value = data.fullName
      	set trn.City.Value = data.location.cityName
      	set trn.OrganizerInfo.Value = data.organizer.info
   	}
      	
    set trn.IdInternal = data.idInternal
    set trn.IdExternal = data.idExternal
    set trn.Hash = data.hash
      	
    set trn.OrganizerSite = data.organizer.site
    
   	set trn.Country = ##class(Dance.Data.Country).%OpenId(data.location.country.id)
    set trn.TStatus = ##class(Dance.Data.TournamentStatus).%OpenId(data.status.id)
    set trn.TRank = ##class(Dance.Data.TournamentRank).%OpenId(data.rank.id)
      	
    set trn.StartDate = $ZDATEH(data.startDate, 15)
    set trn.EndDate = $ZDATEH(data.endDate, 15)
    
    set trn.TabUDSRAllowed = data.tabUDSRAllowed = $$$YES
    set trn.TabWDSFAllowed = data.tabWDSFAllowed = $$$YES
    set trn.TabOtherAllowed = data.tabOtherAllowed = $$$YES
         		
    set st = trn.%Save()
    		
	quit trn
]]></Implementation>
</Method>

<Method name="Deactivate">
<Description>
Change IsActive property to 0</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(Dance.Utils.Journal).Create("Log", "Data.Tournament.Deactivate", "ID="_id_";")
	
	set trn = ..%OpenId(id)
	set trn.IsActive = 0
	set trn.IdInternal = trn.IdInternal_";"_id
	set trn.IdExternal = trn.IdExternal_";"_id
	set trn.Hash = trn.Hash_";"_id
	
	for i=1:1:trn.Competitions.Count(){
		set st = ##class(Dance.Data.Competition).Deactivate(trn.Competitions.GetAt(i).%Id())
		if $$$ISERR(st) return st
	}
	
	quit trn.%Save()
]]></Implementation>
</Method>

<Method name="CheckDeletePrivilege">
<Description>
Check delete privilege</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	SET SQLCODE=""
	&sql(%CHECKPRIV DELETE ON Dance_Data.Tournament)
	if (SQLCODE = 100) quit ##class(Dance.Utils.Msg).GetErrorStatus("error_NoPrivilegeForDelete", " USERNAME="_$USERNAME)
	
	quit $$$OK
]]></Implementation>
</Method>

<Method name="CheckUpdatePrivilege">
<Description>
Check update privilege</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	SET SQLCODE=""
	&sql(%CHECKPRIV UPDATE ON Dance_Data.Tournament)
	if (SQLCODE = 100) quit ##class(Dance.Utils.Msg).GetErrorStatus("error_NoPrivilegeForUpdate", " USERNAME="_$USERNAME)
	
	quit $$$OK
]]></Implementation>
</Method>

<Method name="GetCompetitionsCount">
<ClassMethod>1</ClassMethod>
<FormalSpec>tournamentId:%String</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	set count = 0
	&sql(SELECT COUNT(ID) INTO :count 
		 FROM Dance_Data.Competition 
		 WHERE Tournament = :tournamentId AND IsActive = 1)
		 
	quit count
]]></Implementation>
</Method>

<Method name="GetParticipantsCount">
<ClassMethod>1</ClassMethod>
<FormalSpec>tournamentId:%String</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	set count = 0
	set notTicketStatus = "Canceled"
	
	if (##class(Dance.Data.Tournament).CheckDeletePrivilege() = $$$OK){
		set notTicketStatus = "-"
	}
	
	&sql(SELECT TotalCount - OtherCount As Total INTO :count
		 FROM(
			SELECT COUNT(ID) As TotalCount, 
				  (SELECT COUNT(ID) 
				   FROM Dance_Data.Participant 
				   WHERE Competition->Tournament = :tournamentId AND IsActive = 1 AND (PType = 'CoupleOther' OR PType = 'SingleOther') AND TicketStatus = 'Not paid') As OtherCount 
		    FROM Dance_Data.Participant 
		    WHERE Competition->Tournament = :tournamentId AND IsActive = 1 AND TicketStatus <> :notTicketStatus))
	
	quit count
]]></Implementation>
</Method>

<Method name="GetParticipantsUniqueCount">
<ClassMethod>1</ClassMethod>
<FormalSpec>tournamentId:%String</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	set prtCplAth = 0
	set notTicketStatus = "Canceled"
	
	if (##class(Dance.Data.Tournament).CheckDeletePrivilege() = $$$OK){
		set notTicketStatus = "-"
	}
	
	&sql(DECLARE PrtUniqCrs CURSOR FOR 
		 	SELECT ID, PType, Competition
		 	FROM Dance_Data.Participant
		 	WHERE Competition->Tournament = :tournamentId AND IsActive = 1 AND TicketStatus <> :notTicketStatus)	
		
	&sql(OPEN PrtUniqCrs)
	for  
	{	
		&sql(FETCH PrtUniqCrs INTO :id, :pType, :competitionId) 
		quit:(SQLCODE '= 0)
	
		set (cplId,athId) = ""
		set prtId = pType
		
		if (pType = "CoupleUDSR"){
			&sql(SELECT Couple INTO :cplId
				 FROM Dance_Data.ParticipantCoupleUDSR
				 WHERE ID = :id)
			
			set prtId = prtId_";"_cplId
		}
		elseif (pType = "CoupleWDSF"){
			&sql(SELECT Couple INTO :cplId
				 FROM Dance_Data.ParticipantCoupleWDSF
				 WHERE ID = :id)
				 
			set prtId = prtId_";"_cplId
		}
		elseif (pType = "SingleUDSR"){
			&sql(SELECT Athlete INTO :athId
				 FROM Dance_Data.ParticipantSingleUDSR
				 WHERE ID = :id)
			
			set prtId = prtId_";"_athId
		}
		elseif (pType = "SingleWDSF"){
			&sql(SELECT Athlete INTO :athId
				 FROM Dance_Data.ParticipantSingleWDSF
				 WHERE ID = :id)
			
			set prtId = prtId_";"_athId
		}
		elseif (pType = "CoupleOther"){
			&sql(SELECT CoupleKey INTO :cplId
				 FROM Dance_Data.ParticipantCoupleOther
				 WHERE ID = :id AND TicketStatus <> 'Not paid')
			
			set prtId = prtId_";"_cplId
		}
		elseif (pType = "SingleOther"){
			&sql(SELECT AthleteKey INTO :athId
				 FROM Dance_Data.ParticipantSingleOther
				 WHERE ID = :id AND TicketStatus <> 'Not paid')
				 
			set prtId = prtId_";"_athId
		}
		
		if ($GET(prtCplAth(prtId)) = ""){
			set prtCplAth = prtCplAth + 1
			set prtCplAth(prtId) = "1"
		}		
	}
	
	&sql(CLOSE PrtUniqCrs)
	
	quit prtCplAth
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^Dance.Data.TournamentD</DataLocation>
<DefaultData>TournamentDefaultData</DefaultData>
<IdLocation>^Dance.Data.TournamentD</IdLocation>
<IndexLocation>^Dance.Data.TournamentI</IndexLocation>
<StreamLocation>^Dance.Data.TournamentS</StreamLocation>
<ExtentSize>100000</ExtentSize>
<Data name="TournamentDefaultData">
<Value name="1">
<Value>%%CLASSNAME</Value>
</Value>
<Value name="2">
<Value>Title</Value>
</Value>
<Value name="3">
<Value>StartDate</Value>
</Value>
<Value name="4">
<Value>EndDate</Value>
</Value>
<Value name="5">
<Value>OrganizerSite</Value>
</Value>
<Value name="6">
<Value>TClass</Value>
</Value>
<Value name="7">
<Value>Name</Value>
</Value>
<Value name="8">
<Value>TRank</Value>
</Value>
<Value name="9">
<Value>TStatus</Value>
</Value>
<Value name="10">
<Value>OrganizerInfo</Value>
</Value>
<Value name="11">
<Value>Country</Value>
</Value>
<Value name="12">
<Value>City</Value>
</Value>
<Value name="13">
<Value>TournirId</Value>
</Value>
<Value name="14">
<Value>TournirIdExt</Value>
</Value>
<Value name="15">
<Value>IdInternal</Value>
</Value>
<Value name="16">
<Value>Hash</Value>
</Value>
<Value name="17">
<Value>IdExternal</Value>
</Value>
<Value name="18">
<Value>IsRemoved</Value>
</Value>
<Value name="19">
<Value>IsActive</Value>
</Value>
<Value name="20">
<Value>FullName</Value>
</Value>
<Value name="21">
<Value>TabUDSRAllowed</Value>
</Value>
<Value name="22">
<Value>TabWDSFAllowed</Value>
</Value>
<Value name="23">
<Value>TabOtherAllowed</Value>
</Value>
<Value name="24">
<Value>AccessCode</Value>
</Value>
</Data>
</Storage>
</Class>
</Export>
