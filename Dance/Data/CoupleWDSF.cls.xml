<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="Dance.Data.CoupleWDSF">
<Super>Couple</Super>
<TimeCreated>63436,60745.081748</TimeCreated>

<Property name="WDSFId">
<Type>%String</Type>
<Required>1</Required>
</Property>

<Property name="CStatus">
<Type>%String</Type>
<Required>1</Required>
</Property>

<Property name="AgeCategory">
<Type>%String</Type>
<Required>1</Required>
</Property>

<Property name="Updated">
<Type>%TimeStamp</Type>
<Required>1</Required>
</Property>

<Method name="ConvertToProxyObject">
<ReturnType>%ZEN.proxyObject</ReturnType>
<Implementation><![CDATA[
	set proxy = ##super()
	
	/*
	set proxy.otherInfo.country = ##class(Country).ConvertToProxyObject(..Man.Country)
			
	if (..Man.NumberWDSF = "") && (..Woman.NumberWDSF = ""){
		set club = ..Man.Club
		if (club = "") set club = ..Woman.Club 
		
		set mainTrainer = ..Man.MainTrainer
		if (mainTrainer = "") set mainTrainer = ..Woman.MainTrainer 
		
		set otherTrainers = ..Man.OtherTrainers
		if (otherTrainers = "") set otherTrainers = ..Woman.OtherTrainers
		
		set proxy.otherInfo.city = ..Man.City
		set proxy.otherInfo.club = club
		set proxy.otherInfo.mainTrainer = mainTrainer
		set proxy.otherInfo.otherTrainers = otherTrainers
	}
	elseif (convertParams.tournamentId '= ""){
		set coupleInfo = ..GetWDSFOtherInfoForTournament(convertParams.tournamentId, proxy.id)
		set proxy.man.dob = coupleInfo.manDob
		set proxy.woman.dob = coupleInfo.womanDob
		set proxy.otherInfo.city = coupleInfo.city
		set proxy.otherInfo.club = coupleInfo.club
		set proxy.otherInfo.mainTrainer = coupleInfo.mainTrainer
		set proxy.otherInfo.otherTrainers = coupleInfo.otherTrainers
	}
	*/
	quit proxy
]]></Implementation>
</Method>

<Method name="GetByNumbers">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[manId:%String,womanId:%String,&st]]></FormalSpec>
<ReturnType>Couple</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	#dim obj As CoupleWDSF = ""
	
	if (..CommonIdxExists(manId, womanId)){
		set obj = ..CommonIdxOpen(manId, womanId)
		set diffDays = $SYSTEM.SQL.DATEDIFF("dd", $P(obj.Updated, " ", 1), $P($ZDT($ZTS, 3), " ", 1))
		if (diffDays <= 7){
			return obj
		}	
	}
	
	set wdsfData = ##class(Dance.Wdsf.ControllerAPI).GetCoupleByNumbers(manId, womanId, .st)
	quit:$$$ISERR(st) obj
	
	set obj = ..%New()
	set obj.WDSFId = wdsfData.id
	set obj.Man = ##class(PersonWDSF).SaveFromWDSF(wdsfData.man, .st)	
	quit:$$$ISERR(st) obj
	
	set obj.Woman = ##class(PersonWDSF).SaveFromWDSF(wdsfData.woman, .st)	
	quit:$$$ISERR(st) obj
	
	set obj.AgeCategory = wdsfData.ageGroup
	set obj.CStatus = wdsfData.status
	
	set obj.Updated = $ZDT($ZTS, 3)
	set st = obj.%Save()
	
	quit obj
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>CoupleWDSFDefaultData</DefaultData>
<Data name="CoupleWDSFDefaultData">
<Subscript>"CoupleWDSF"</Subscript>
<Value name="1">
<Value>WDSFId</Value>
</Value>
<Value name="2">
<Value>CStatus</Value>
</Value>
<Value name="3">
<Value>AgeCategory</Value>
</Value>
<Value name="4">
<Value>Updated</Value>
</Value>
</Data>
</Storage>
</Class>
</Export>
