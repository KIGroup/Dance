<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<CSP name="dance/js/controllers/CompetitionParticipantsCtrl.js" application="/csp/dance/" default="1"><![CDATA[
'use strict';
//csddddddd
 
/*===========================================================================================
Competition Participants 
===========================================================================================*/

controllersModule.controller('CompetitionParticipantsCtrl', function($scope, $location, $routeParams, $filter, UtilsSrvc, CompetitionSrvc, ParticipantSrvc){
	//$scope.menu.selectMenu('tournaments');;
	$scope.page = {};
  $scope.page.participantTable = {};

 	if (!$scope.pageStore.participants) $scope.pageStore.participants = {grid:{}};

    
    $scope.page.init = function(){
      //    
    	// Participant table
    	//  
        $scope.page.participantTable.columns = [
                          {name: 'Партнер / партнерша', sqlName: 'Couple->Man->LastName->Value'     , isSorted: true , isSortable: true , isDown: true, isSearched: true , isSearchable: true, captionStyle: {width: '250px'}},
                          {name: 'Класс'       , sqlName: '-'                                , isSorted: false, isSortable: false, isDown: true, isSearched: false, isSearchable: false, captionStyle: {textAlign: 'center', width: '50px'}},
                          {name: 'Клуб / Город', sqlName: '-'                                , isSorted: false, isSortable: true , isDown: true, isSearched: false, isSearchable: true},
                          {name: 'Тренер(ы)'   , sqlName: '-'                                , isSorted: false, isSortable: false, isDown: true, isSearched: false, isSearchable: false},
                          {name: 'Страна'      , sqlName: 'Couple->Man->Country->Name->Value', isSorted: false, isSortable: true , isDown: true, isSearched: false, isSearchable: true},
                          {name: 'Группы'      , sqlName: '-'                                , isSorted: false, isSortable: false, isDown: true, isSearched: false, isSearchable: false, captionStyle: {textAlign: 'center', width: "70px"}}];
        
        $scope.page.participantTable.properties = [
        				  {name:'couple.fullName', 
                                                getCssClass: function(item){
                                                    return $scope.page.participantTable.getCssClassForPaymentStatus(item.paymentStatus);
                                                },
                                                calculate: function(item){ 
                                                    if (item.couple.man.id == item.couple.woman.id){
                                                        item.couple.fullName = item.couple.man.lastName + ' ' + item.couple.man.firstName + '\n';
                                                    } 
                                                    else{
                                                        item.couple.fullName = item.couple.man.lastName + ' ' + item.couple.man.firstName;
                                                        item.couple.fullName += '\n' + item.couple.woman.lastName + ' ' + item.couple.woman.firstName;
                                                    }
                                                }},
                          {name:'couple.class', cellStyle: {textAlign: 'center'}, 
                                                getCssClass: function(item){ 
                                                    return $scope.page.participantTable.getCssClassForPaymentStatus(item.paymentStatus);
                                                },
                                                calculate: function(item){
                                                    var manClass,womanClass;

                                                    if ($scope.page.competition.discipline.code == 'Ла'){                                                        
                                                        manClass = item.couple.man.laClass.name;
                                                        womanClass = item.couple.woman.laClass.name;
                                                    }
                                                    else if($scope.page.competition.discipline.code == 'Ст'){
                                                        manClass = item.couple.man.stClass.name;
                                                        womanClass = item.couple.woman.stClass.name;
                                                    }

                                                    if (!manClass) manClass = '-';
                                                    if (!womanClass) womanClass = '-';

                                                    item.couple.class = manClass + '\n' + womanClass;
                                                }},
                          {name:'couple.otherInfo.clubAndCity', 
                                                getCssClass: function(item){ 
                                                    return $scope.page.participantTable.getCssClassForPaymentStatus(item.paymentStatus);
                                                },
                                                calculate: function(item){
                                                    item.couple.otherInfo.clubAndCity = item.couple.otherInfo.club + '\n' + item.couple.otherInfo.city;
                                                }}, 
                          {name:'couple.otherInfo.trainers', 
                                                getCssClass: function(item){ 
                                                    return $scope.page.participantTable.getCssClassForPaymentStatus(item.paymentStatus);
                                                },
                                                calculate: function(item){
                                                    item.couple.otherInfo.trainers = item.couple.otherInfo.mainTrainer + (item.couple.otherInfo.otherTrainers=='' ? '' : (', ' + item.couple.otherInfo.otherTrainers));
                                                }},
                          {name:'couple.otherInfo.country.name',
                                                getCssClass: function(item){ 
                                                    return $scope.page.participantTable.getCssClassForPaymentStatus(item.paymentStatus);
                                                }},
                          {name:'coupleCompetitionsCountString', cellStyle: {textAlign: 'center'}, cellSelectable: true, cellTitle: $filter('localize')('Открыть список групп, в которых зарегистрирована пара'),
                                                getCssClass: function(item){ 
                                                    return 'cellCoupleLink';
                                                }, 
                                                calculate: function(item){
                                                    item.coupleCompetitionsCountString = item.coupleCompetitionsCount + ' »';
                                                },
                                                onClickCell: function(coupleId){
                                                    $location.path("/tournament/" + $scope.page.competition.tournament.id + "/couple/" + coupleId + "/competitions"); 
                                                }}];

        $scope.page.participantTable.pageSize = 30;
        $scope.page.participantTable.pageCurr = 1;
        $scope.page.participantTable.itemsTotal = 0;
        $scope.page.participantTable.selectedItems = [];
        $scope.page.participantTable.multiSelectMode = false;
        $scope.page.participantTable.forciblyUpdate = 0;
    };



    // 
    $scope.page.participantTable.loadItems = function(pageCurr, pageSize, sqlName, isDown, searchSqlName, searchText){
        $scope.page.participantTable.itemsStatus = $filter('localize')('Идет загрузка данных...');

        ParticipantSrvc.getAllForGrid(pageCurr, pageSize, sqlName, isDown, searchSqlName, searchText, {competitionId: $scope.page.competition.id}).then(
            function(data){
	            data = data.children;
                $scope.page.participantTable.pageTotal = Math.ceil(data.itemsTotal / pageSize);
                $scope.page.participantTable.itemsTotal = data.itemsTotal;
                $scope.page.participantTable.items = data.items;

                $scope.page.participantTable.itemsStatus = data.itemsTotal == 0 ? $filter('localize')('Нет данных.') : '';
            },
            function(data){
                $scope.page.alert = UtilsSrvc.getAlert('Внимание!', data, 'error', true);
                $scope.page.participantTable.itemsStatus = $filter('localize')('Произошла ошибка при загрузке данных.');
            });
    };

    $scope.page.participantTable.getCssClassForPaymentStatus = function(status){
        switch(status){
            case 'cancel':
                return 'cancelCouplePayment';
            case 'none':
                return 'noneCouplePayment';
            case 'pay': 
                return '';
        }

        return '';
    };

  	$scope.page.participantTable.refresh = function(){ 
    	$scope.page.participantTable.forciblyUpdate++; 
    };
     
    $scope.page.participantTable.onSelectCell = function(item, property){ 
        if (!item) return;

        property.onClickCell(item.couple.id);
    };


    $scope.page.participantTable.remove = function(item){
        function remove(){
            ParticipantSrvc.removeById(item.id).then(
                function(data){
                    $scope.page.participantTable.selectedItems = [];
                    $scope.page.participantTable.refresh();
                    $scope.page.alert = UtilsSrvc.getAlert('Готово!', 'Участник удален.', 'success', true);
                },
                function(data, status, headers, config){
                    $scope.page.alert = UtilsSrvc.getAlert('Внимание!', data, 'error', true);
                });  
        };

        UtilsSrvc.openMessageBox('Удалить пару / участника из группы?', item.couple.man.lastName + ' - ' + item.couple.woman.lastName, remove);    
    };
    
    /// Load Competition by ID
    $scope.page.loadCompetition = function(competitionId){
        CompetitionSrvc.getById(competitionId).then(
            function(data){
                $scope.page.competition = data;
                $scope.page.participantTable.refresh();
            },
            function(data, status, headers, config){
                $scope.page.alert = UtilsSrvc.getAlert('Внимание!', data, 'error', true);
            });
    };   

    
    $scope.page.init();
    $scope.page.loadCompetition($routeParams.competitionId);
});

]]></CSP>
</Export>
